window.addEventListener("load",()=>{document.body.classList.remove("invisible")});let firstScan=!0;const STRUCTURE=[3,4,5,4,3],MIN_PIPS_PER_RESOURCE={bois:11,ble:11,mouton:11,argile:9,minerai:9},RESSOURCES_POOL=["bois","bois","bois","bois","argile","argile","argile","mouton","mouton","mouton","mouton","ble","ble","ble","ble","minerai","minerai","minerai","desert"],NUMEROS_POOL=[2,3,3,4,4,5,5,6,6,8,8,9,9,10,10,11,11,12],PROB_POINTS={2:1,12:1,3:2,11:2,4:3,10:3,5:4,9:4,6:5,8:5},VERTEX_ADJ={1:[4,5],2:[5,6],3:[6,7],4:[1,8],5:[1,2,9],6:[2,3,10],7:[3,11],8:[4,12,13],9:[5,13,14],10:[6,14,15],11:[7,15,16],12:[8,17],13:[8,9,18],14:[9,10,19],15:[10,11,20],16:[11,21],17:[12,22,23],18:[13,23,24],19:[14,24,25],20:[15,25,26],21:[16,26,27],22:[17,28],23:[17,18,29],24:[18,19,30],25:[19,20,31],26:[20,21,32],27:[21,33],28:[22,34],29:[23,34,35],30:[24,35,36],31:[25,36,37],32:[26,37,38],33:[27,38],34:[28,29,39],35:[29,30,40],36:[30,31,41],37:[31,32,42],38:[32,33,43],39:[34,44],40:[35,44,45],41:[36,45,46],42:[37,46,47],43:[38,47],44:[39,40,48],45:[40,41,49],46:[41,42,50],47:[42,43,51],48:[44,52],49:[45,52,53],50:[46,53,54],51:[47,54],52:[48,49],53:[49,50],54:[50,51]},VERTEX_TO_HEX={1:[0],2:[1],3:[2],4:[0],5:[0,1],6:[1,2],7:[2],8:[0,3],9:[0,1,4],10:[1,2,5],11:[2,6],12:[3],13:[0,3,4],14:[1,4,5],15:[2,5,6],16:[6],17:[3,7],18:[3,4,8],19:[4,5,9],20:[5,6,10],21:[6,11],22:[7],23:[3,7,8],24:[4,8,9],25:[5,9,10],26:[6,10,11],27:[11],28:[7],29:[7,8,12],30:[8,9,13],31:[9,10,14],32:[10,11,15],33:[11],34:[7,12],35:[8,12,13],36:[9,13,14],37:[10,14,15],38:[11,15],39:[12],40:[12,13,16],41:[13,14,17],42:[14,15,18],43:[15],44:[12,16],45:[13,16,17],46:[14,17,18],47:[15,18],48:[16],49:[16,17],50:[17,18],51:[18],52:[16],53:[17],54:[18]},EDGES={top:[6,2,5,1,4],topLeft:[8,12,17,22,28],bottomLeft:[34,39,44,48,52],bottom:[49,53,50,54,51],bottomRight:[47,43,38,33,27],topRight:[21,16,11,7,3]},BORDS={b21:["mouton","mouton",null,"3p1","3p1"],b16:[null,"3p1","3p1",null,null],b65:["argile","argile",null,"3p1","3p1"],b54:[null,"bois","bois",null,null],b43:["ble","ble",null,"3p1","3p1"],b32:[null,"minerai","minerai",null,null]},bordToEdge={0:"top",1:"topRight",2:"bottomRight",3:"bottom",4:"bottomLeft",5:"topLeft"};let vertexData={};const routesExistantes=new Set,routesCouleurs={};function shuffle(e){let t,o=e.length;for(;0!==o;)t=Math.floor(Math.random()*o),o--,[e[o],e[t]]=[e[t],e[o]];return e}function getDistanceEntreSommets(e,t,o=10){if(e===t)return 0;const n=new Set([e]);let r=[e],s=0;for(;r.length&&s<o;){s++;const e=[];for(const o of r)for(const r of VERTEX_ADJ[o]||[]){if(r===t)return s;n.has(r)||(n.add(r),e.push(r))}r=e}return 1/0}function ajouterRoute(e,t,o="rouge"){const n=[Math.min(e,t),Math.max(e,t)].join("-");routesExistantes.add(n),routesCouleurs[n]=o.toLowerCase()}function routeExiste(e,t){const o=[Math.min(e,t),Math.max(e,t)].join("-");return routesExistantes.has(o)}function routeCouleur(e,t){const o=[Math.min(e,t),Math.max(e,t)].join("-");return routesCouleurs[o]??null}function voisinsSansRoute(e){return(VERTEX_ADJ[e]||[]).filter(t=>!routeExiste(e,t))}function routeExisteEntre(e,t){return Array.from(document.querySelectorAll(".route")).some(o=>{const n=Number(o.dataset.pion),r=Number(o.dataset.voisin);return n===e&&r===t||n===t&&r===e})}function poserUneRouteDepuisPion(e){const t=document.getElementById("routes-layer");if(!t)return;const o=document.querySelector(`.pos${e}`);if(!o)return;if("true"===o.dataset.routeCree)return;o.dataset.routeCree="true";const n=o.dataset.couleur?.toLowerCase()||"rouge",r=VERTEX_ADJ[e];if(!r||0===r.length)return;const s=r[Math.floor(Math.random()*r.length)],i=getSommetCenterPercent(e),a=getSommetCenterPercent(s);if(!i||!a)return;const c=(i.x+a.x)/2,u=(i.y+a.y)/2;let l=180*Math.atan2(a.y-i.y,a.x-i.x)/Math.PI;const d=[0,30,90,150,180,-30,-90,-150].reduce((e,t)=>Math.abs(t-l)<Math.abs(e-l)?t:e);let m=0,f=0,g=1;switch(d){case-90:case 90:g=1.05;break;case 30:f=4,m=2;break;case 150:f=4,m=-2}const h=document.createElement("div");h.classList.add("route",`rou-${n}`),h.style.left=`${c}%`,h.style.top=`${u}%`,h.style.transform=`\n    translate(calc(-50% + ${m}%), calc(-50% + ${f}%))\n    rotate(${d}deg)\n    scaleX(${g})\n  `,h.style.zIndex="60",h.dataset.pion=e,h.dataset.voisin=s,h.dataset.couleur=n,h.dataset.angleReel=l.toFixed(2),h.dataset.angleFixe=d,h.dataset.scaleX=g,t.appendChild(h),ajouterRoute(e,s,n)}function buildHexAdjacency(e){const t=[];let o=0;for(let n=0;n<e.length;n++)t[n]=o,o+=e[n];const n=Array.from({length:o},()=>new Set);for(let o=0;o<e.length;o++){const r=e[o];for(let s=0;s<r;s++){const i=t[o]+s;if(s-1>=0&&n[i].add(i-1),s+1<r&&n[i].add(i+1),o>0){const a=e[o-1],c=t[o-1];a===r-1?(s-1>=0&&n[i].add(c+(s-1)),s<a&&n[i].add(c+s)):a===r+1&&(n[i].add(c+s),n[i].add(c+s+1))}if(o<e.length-1){const a=e[o+1],c=t[o+1];a===r-1?(s-1>=0&&n[i].add(c+(s-1)),s<a&&n[i].add(c+s)):a===r+1&&(n[i].add(c+s),n[i].add(c+s+1))}}}return n.map(e=>Array.from(e))}function placeResourcesWithConstraints(e,t,o,n,r={}){const s=e.reduce((e,t)=>e+t,0),i=[...t],a=Array(s).fill(null);for(const[e,t]of Object.entries(r)){a[Number(e)]=t;const o=i.indexOf(t);-1!==o&&i.splice(o,1)}return function e(t,r,i){if(t===s)return i;if(null!==i[t])return e(t+1,r,i);const a=shuffle([...new Set(r)]);for(const s of a){if(!r.includes(s))continue;if(!n&&"desert"!==s&&o[t].some(e=>i[e]===s))continue;const a=i.slice();a[t]=s;const c=r.slice();c.splice(c.indexOf(s),1);const u=e(t+1,c,a);if(u)return u}return null}(0,i,a)}function assignNumbersWithConstraints(e,t,o,n,r,s,i,a){const c=[];for(let t=0;t<e.length;t++)"desert"!==e[t]&&c.push(t);let u=0;for(;u<6e3;){const s=shuffle([...t]),l=new Array(e.length).fill(null);for(let e=0;e<c.length;e++)l[c[e]]=s[e];if(isValidLayout(l,o,n,r,e,i,a))return l;u++}const l=new Array(e.length).fill(null),d=shuffle([...t]);for(let e=0;e<c.length;e++)l[c[e]]=d[e];return l}function isValidLayout(e,t,o,n,r,s,i){const a=e=>2===e||12===e;for(let r=0;r<e.length;r++){const s=e[r];for(const a of t[r]){const t=e[a];if(!o&&(6===s&&(6===t||8===t)||8===s&&(6===t||8===t)))return!1;if(!n&&(2===s&&(2===t||12===t)||12===s&&(2===t||12===t)))return!1;if(!i&&null!=s&&s===t)return!1}}if(!s){const t=Object.create(null);for(let o=0;o<e.length;o++){const n=r[o];if(n&&"desert"!==n&&(a(e[o])&&(t[n]=(t[n]||0)+1,t[n]>1)))return!1}}return!0}function checkEquilibreGlobalSommets(e,t,{log:o=!0,min:n=7,max:r=11}={}){let s=!0,i=0,a=0;for(let o=1;o<=54;o++){const c=VERTEX_TO_HEX[o]||[];if(c.length<3)continue;let u=0;for(const o of c){if("desert"===e[o])continue;const n=t[o];n&&PROB_POINTS[n]&&(u+=PROB_POINTS[n])}i+=u,a++,(u<n||u>r)&&(s=!1)}if(o){(i/Math.max(a,1)).toFixed(1)}return s}function enforceEquilibreSommets(e,t,o,n={},r=200){let s=0;for(;!checkEquilibreGlobalSommets(e,t,{log:!1,...n})&&s<r;)t=assignNumbersWithConstraints(e,NUMEROS_POOL,o,document.getElementById("sixhuit").checked,document.getElementById("deuxdouze").checked,document.getElementById("sameResRule").checked,document.getElementById("ressourceRule").checked,document.getElementById("sameNumberRule").checked),s++;return{ok:checkEquilibreGlobalSommets(e,t,{log:!0,...n}),numbersByIndex:t}}function computePipsPerResource(e,t){const o={bois:0,mouton:0,ble:0,argile:0,minerai:0};for(let n=0;n<e.length;n++){const r=e[n],s=t[n];r&&"desert"!==r&&(o[r]+=PROB_POINTS[s]||0)}return o}function checkMinPipsPerResourceMap(e,t,o){const n=computePipsPerResource(e,t),r=Object.keys(n).filter(e=>n[e]<(o[e]??0));return{ok:0===r.length,sums:n,below:r}}function enforceMinPipsPerResourceMap(e,t,o,n,r=200){let s=0,i=checkMinPipsPerResourceMap(e,t,n);for(;!i.ok&&s<r;)t=assignNumbersWithConstraints(e,NUMEROS_POOL,o,document.getElementById("sixhuit").checked,document.getElementById("deuxdouze").checked,document.getElementById("sameResRule").checked,document.getElementById("ressourceRule").checked,document.getElementById("sameNumberRule").checked),i=checkMinPipsPerResourceMap(e,t,n),s++;if(i.ok){Object.entries(n).map(([e,t])=>`${e}: ${i.sums[e]} ≥ ${t}`).join(" | ")}return{ok:i.ok,numbersByIndex:t,sums:i.sums,tries:s}}function logPipsPerResource(e,t){const o=computePipsPerResource(e,t);Object.entries(o).forEach(([e,t])=>{})}function checkPortsBalanced_DOM(e,t,o){const n=new Set([6,8]);for(let r=0;r<o.length;r++){const s=o[r],i=EDGES[bordToEdge[r]],a=BORDS[s];for(let o=0;o<a.length-1;o++){const r=a[o];if(!r||"3p1"===r)continue;const s=i[o],c=i[o+1],u=VERTEX_TO_HEX[c]||[],l=(VERTEX_TO_HEX[s]||[]).filter(e=>u.includes(e));for(const o of l){const s=e[o],i=t[o];if(s===r&&n.has(i))return!1}}}return!0}function logHexes(e,t){for(let t=0;t<e.length;t++);}function logBords(e,t,o){o.forEach((o,n)=>{const r=BORDS[o];EDGES[bordToEdge[n]].forEach((o,n)=>{r[n],(VERTEX_TO_HEX[o]||[]).map(o=>`${o}: ${e[o]} ${t[o]??"-"}`).join(" | ")})})}function logVertexData(e,t,o){vertexData={};for(let o=1;o<=54;o++){const n=VERTEX_TO_HEX[o]||[];vertexData[o]={hexes:n.map(o=>({idx:o,res:e[o],num:t[o]??"-"})),ports:[]}}for(let e=0;e<o.length;e++){const t=o[e],n=EDGES[bordToEdge[e]],r=BORDS[t];for(let e=0;e<r.length;e++){const t=r[e];if(!t)continue;const o=n[e];vertexData[o]&&vertexData[o].ports.push(t)}}return Object.entries(vertexData).forEach(([e,t])=>{t.hexes.map(e=>`${e.res} ${e.num}`).join(" | "),t.ports.length&&t.ports.join(", ")}),vertexData}function getResourcesAroundVertex(e){const t=vertexData?.[e];if(!t)return{ressources:[],ports:[]};return{ressources:(t.hexes||[]).map(e=>e.res).filter(e=>e&&"desert"!==e),ports:(t.ports||[]).map(e=>"3p1"===e?"port":e)}}function getSommetCenterPercent(e){const t=document.getElementById("plateau-container"),o=document.getElementById("colonies-layer");if(!t||!o)return null;let n=document.querySelector(`.pos${e}`),r=!1;n||(n=document.createElement("div"),n.className=`pos${e}`,n.style.position="absolute",n.style.width="0",n.style.height="0",n.style.visibility="hidden",o.appendChild(n),r=!0);const s=n.getBoundingClientRect(),i=t.getBoundingClientRect(),a=(s.left+s.width/2-i.left)/i.width*100,c=(s.top+s.height/2-i.top)/i.height*100;return r&&n.remove(),{x:a,y:c}}function generation(e=0){"number"!=typeof e&&(e=0);if(e>=500)return;const t=document.getElementById("nombre").checked,o=document.getElementById("colonie").checked,n=(document.getElementById("route").checked,document.getElementById("mer").checked),r=document.getElementById("desertCentre").checked,s=document.getElementById("sixhuit").checked,i=document.getElementById("deuxdouze").checked,a=document.getElementById("sameResRule").checked,c=document.getElementById("ressourceRule").checked,u=document.getElementById("portRule").checked,l=document.getElementById("equilibreRule").checked,d=document.getElementById("minPipsPerResourceRule").checked,m=document.getElementById("sameNumberRule").checked,f=document.getElementById("plateau-container");f.innerHTML="";const g=document.createElement("div");g.id="routes-layer",g.style.position="absolute",g.style.inset="0",g.style.zIndex="45",g.style.pointerEvents="none",f.appendChild(g);const h=document.createElement("div");h.id="colonies-layer",h.style.position="absolute",h.style.inset="0",h.style.zIndex="50",h.style.pointerEvents="none",f.appendChild(h),f.appendChild(Object.assign(document.createElement("div"),{className:"hex-fond hex-mer"})),f.appendChild(Object.assign(document.createElement("div"),{className:"hex-fond hex-route"}));const p=document.createElement("div");p.id="carteCatan",f.appendChild(p);const b=buildHexAdjacency(STRUCTURE);let E=[...RESSOURCES_POOL];const x={};if(r){const e=E.indexOf("desert");-1!==e&&E.splice(e,1),x[9]="desert"}const y=placeResourcesWithConstraints(STRUCTURE,E,b,a,x);if(!y)return generation(e+1);let R=new Array(y.length).fill(null);if(t){if(R=assignNumbersWithConstraints(y,NUMEROS_POOL,b,s,i,a,c,m),l){const t=enforceEquilibreSommets(y,R,b,{min:7,max:11},200);if(R=t.numbersByIndex,!t.ok)return generation(e+1)}if(d){const t=enforceMinPipsPerResourceMap(y,R,b,MIN_PIPS_PER_RESOURCE,200);if(R=t.numbersByIndex,!t.ok)return generation(e+1)}}let v=0;for(let e=0;e<STRUCTURE.length;e++){const o=document.createElement("div");o.classList.add("ligne",`ligne-${e+1}`);for(let n=0;n<STRUCTURE[e];n++){const e=y[v],n=document.createElement("div");if(n.classList.add("hex",e),n.style.backgroundImage=`url('image/ressource/${e}.png')`,n.dataset.hexIndex=String(v),t&&"desert"!==e){const e=R[v],t=document.createElement("img");t.src=`image/numero/${e}.png`,t.classList.add("numero"),n.appendChild(t)}o.appendChild(n),v++}p.appendChild(o)}let P=["b21","b16","b65","b54","b43","b32"];if(n&&(P=shuffle(P)),P.forEach((e,t)=>{const o=document.createElement("div");o.className=`bord b${t+1}`;const n=document.createElement("img");n.src=`image/bord/${e}.png`,n.alt=e,o.appendChild(n),f.appendChild(o)}),u){if(!checkPortsBalanced_DOM(y,R,P))return generation(e+1)}logHexes(y,R),logBords(y,R,P),vertexData=logVertexData(y,R,P),logPipsPerResource(y,R),h.innerHTML="",g.innerHTML="";const S=document.getElementById("analyse-bar");S&&S.classList.add("hidden");const B=["Rouge","Bleu","Orange","Beige"].some(e=>document.getElementById(e)?.checked);o&&B&&afficherPions()}function getSeuilsEquilibrage(e){switch(e){case 1:return{nom:1,ressourcesTotales:0,ressourcesDistinctes:0,ressourcesParPion:0,distanceMin:2,boisArgileObligatoire:!1,maxPortsParJoueur:1/0,maxRatio:1/0};case 2:return{nom:2,ressourcesTotales:4,ressourcesDistinctes:2,ressourcesParPion:1,distanceMin:2,boisArgileObligatoire:!0,maxPortsParJoueur:2,maxRatio:1.3};case 3:return{nom:3,ressourcesTotales:5,ressourcesDistinctes:3,ressourcesParPion:2,distanceMin:4,boisArgileObligatoire:!0,maxPortsParJoueur:1,maxRatio:1.1};default:return getSeuilsEquilibrage(2)}}function afficherPions(e=200){window.__isFinalBoard=!1;const t=document.getElementById("colonies-layer"),o=document.getElementById("routes-layer"),n=document.getElementById("route").checked;t.innerHTML="",o.innerHTML="";const r=[];if(["Rouge","Bleu","Orange","Beige"].forEach(e=>{document.getElementById(e)?.checked&&r.push(e.toLowerCase())}),0===r.length)return;const s=Number(document.querySelector('input[name="niveauEquilibre"]:checked')?.value||1),i=getSeuilsEquilibrage(s);let a=!1,c=0;for(window.__isFinalBoard=!1;!a&&c<e;){c++,t.innerHTML="",o.innerHTML="",routesExistantes.clear();let e=Array.from({length:54},(e,t)=>t+1);const u={};let l=!0;const d=[...r,...[...r].reverse()];for(const o of d){let r=null,s=0,a=!1;for(;!a&&s<300;){s++,r=e[Math.floor(Math.random()*e.length)];const t=getResourcesAroundVertex(r),n=new Set(t.ressources),c=new Set(t.ports),l=new Set([...n,...c]),d=u[o]?.[0];let m=!0,f=l.size>=i.ressourcesParPion,g=!i.boisArgileObligatoire||l.has("bois")||l.has("argile");if(d){m=getDistanceEntreSommets(d,r)>=i.distanceMin}a=m&&f&&g}if(!a){l=!1;break}const c=document.createElement("div");c.classList.add("pion",`pos${r}`,`col-${o}`),c.dataset.couleur=o,t.appendChild(c),u[o]||(u[o]=[]),u[o].push(r),n&&poserUneRouteDepuisPion(r,o);const d=new Set([r]);(VERTEX_ADJ[r]||[]).forEach(e=>d.add(e)),e=e.filter(e=>!d.has(e))}if(!l)continue;let m=!0;const f=[];for(const e of r){const[t,o]=u[e]||[];if(!t||!o){m=!1;continue}const n=getResourcesAroundVertex(t),r=getResourcesAroundVertex(o),s=new Set(n.ressources).size+(n.ports||[]).length,a=new Set(r.ressources).size+(r.ports||[]).length,c=new Set([...n.ressources,...r.ressources]),l=[...n.ports||[],...r.ports||[]],d=[...new Set([...c,...l])],g=[...n.ressources,...r.ressources,...l],h=["bois","argile"].filter(e=>d.includes(e)),p=g.length,b=c.size,E=getDistanceEntreSommets(t,o),x=p>=i.ressourcesTotales,y=b>=i.ressourcesDistinctes,R=s>=i.ressourcesParPion&&a>=i.ressourcesParPion,v=!i.boisArgileObligatoire||h.length>0,P=E>=i.distanceMin,S=l.length<=i.maxPortsParJoueur,B=x&&y&&R&&v&&P&&S;B||(m=!1),f.push({couleur:e,pions:[t,o],distance:E,infoA:n,infoB:r,ok:{toutOK:B,okPorts:S}})}if(m){const e=routesExistantes.size;if(n&&0===e)a=!1;else{const e=analyseEquilibrageGlobal(f,s,{log:!1});e&&e.ok?(window.__isFinalBoard||(window.__isFinalBoard=!0,analyseFinale=analyseEquilibrageGlobal(f,s,{log:!0}),resultat=f),a=!0):(a=!1,window.__isFinalBoard=!1)}}}a||generation()}function analyseEquilibrageGlobal(e,t,o={log:!0}){const n=getSeuilsEquilibrage(t).maxRatio??1.3,r=e.flatMap(e=>e.pions),s=e.map(e=>{const t=e.couleur||"inconnu",n=analysePositionJoueur(e.pions,r,t,{log:!!o.log}),s=n.scoreOuverture,i=n.ratioOuverture,a=s.toFixed(2),c=[...vertexData[e.pions[0]]?.hexes||[],...vertexData[e.pions[1]]?.hexes||[]],u={2:1,3:2,4:3,5:4,6:5,8:5,9:4,10:3,11:2,12:1},l={argile:1.2,bois:1.1,ble:1,pierre:.9,minerai:.9,mouton:.8};let d=0,m=0;const f={};c.forEach(e=>{if(!e.res||"desert"===e.res||!e.num)return;const t=u[e.num]||0,o=l[e.res]??1,n=t*o;d+=t,m+=n,f[e.res]||(f[e.res]={brut:0,pond:0,coef:o}),f[e.res].brut+=t,f[e.res].pond+=n});const g=Object.keys(f).length,h=1+.3*Math.log(g>0?g:1),p=`1 + 0.3×ln(${g}) = ${h.toFixed(2)}`,b=[...e.infoA?.ports||[],...e.infoB?.ports||[]],E=[];let x=0;b.forEach(e=>{if("3p1"===e||"port"===e||"3:1"===e)x+=3,E.push("port 3:1 = 3.00");else{const t=c.filter(t=>t.res===e&&t.num&&!isNaN(t.num)).reduce((e,t)=>e+(u[t.num]||0),0),o=t>0,n=o?1.5+.6*t:1;x+=n,E.push(`port 2:1 ${e} ${o?"synergique":"non-synergique"} = ${n.toFixed(2)}`)}});const y=m*h+x;return{couleur:t,pipsBruts:d,pips:m,pipsDetail:f,diversite:g,facteurDiversite:h,facteurDiversiteTxt:p,ports:b,portsDetail:E,valeurPorts:x,core:y,score:y*i,facteurOuverture:i,ouvertureNote10:a,ratioOuverture:i,scoreOuverture:s}}),i=s.map(e=>e.score),a=Math.max(...i)/Math.min(...i),c=a<=n,u={};if(s.forEach(e=>{u[e.couleur]=e.score}),o.log){const e={rouge:"🔴",bleu:"🔵",orange:"🟠",beige:"⚪",vert:"🟢",violet:"🟣",jaune:"🟡",noir:"⚫"},o=Math.min(...s.map(e=>e.score)),r=Math.max(...s.map(e=>e.score));s.find(e=>e.score===o),s.find(e=>e.score===r),s.map(t=>`%c${e[t.couleur?.toLowerCase()]||"⚪"} ${t.score.toFixed(2)}%c`).join(" │ "),s.flatMap(e=>[`color:${{rouge:"#e74c3c",bleu:"#3498db",vert:"#27ae60",orange:"#e67e22",jaune:"#f1c40f",beige:"#d2b48c",violet:"#9b59b6",noir:"#2c3e50"}[e.couleur?.toLowerCase()]||"#ccc"}; font-weight:bold;`,"color:inherit;"]);s.forEach(e=>{e.couleur?.toLowerCase(),Object.entries(e.pipsDetail).map(([e,t])=>`${e[0].toUpperCase()+e.slice(1)} = ${t.brut} × ${t.coef.toFixed(2)} = ${t.pond.toFixed(2)}`).join("\n"),Object.values(e.pipsDetail).reduce((e,t)=>e+t.pond,0).toFixed(2),Number(e.pips.toFixed(2)),Number(e.facteurDiversite.toFixed(2)),Number(e.valeurPorts.toFixed(2)),Number(e.facteurOuverture.toFixed(2))});const i=s.reduce((e,t)=>e.score>t.score?e:t),c=s.reduce((e,t)=>e.score<t.score?e:t);i.couleur?.toLowerCase(),c.couleur?.toLowerCase();if("function"==typeof afficherAnalyse){afficherAnalyse({niveau:getSeuilsEquilibrage(t).nom,scores:u,ratio:a,ratioCap:n})}}return{ok:c,ratio:a,maxRatio:n,details:s,scores:u}}function analysePositionJoueur(e,t,o="inconnu",n={log:!1}){const r=!!n.log,s=t.filter(t=>!e.includes(t)),i={2:1,3:2,4:3,5:4,6:5,8:5,9:4,10:3,11:2,12:1},a={argile:1.2,bois:1.1,ble:1,pierre:.9,minerai:.9,mouton:.8},c=new Set,u=new Set;let l=0;const d=[],m=new Set;for(const t of e)(vertexData[t]?.hexes||[]).forEach(e=>{e.res&&"desert"!==e.res&&m.add(e.res)});function f(e){const t=vertexData[e]?.hexes||[],o=vertexData[e]?.ports||[];let n=0;const r=[];for(const e of t)if(e.res&&e.num&&!isNaN(e.num)){const t=i[e.num]||0,o=a[e.res]||1,s=t*o;n+=s,r.push(`⚙️ ${e.res}(${e.num}) = ${t}×${o} = ${s.toFixed(2)}`)}for(const e of o)if(["3p1","port","3:1"].includes(e))n+=3,r.push("⚓ port 3:1 → +3 pts");else{const o=e,s=m.has(o),a=t.filter(e=>e.res===o&&e.num&&!isNaN(e.num)).reduce((e,t)=>e+(i[t.num]||0),0),c=s||a>0?1.5+.6*a:1;n+=c,r.push(`⚓ port ${o} ${s||a>0?"synergique":"non-synergique"} → +${c.toFixed(2)} pts`)}return{total:n,logParts:r}}function g(t){for(const e of s)if(getDistanceEntreSommets(t,e)<2)return!1;for(const o of e)if(getDistanceEntreSommets(t,o)<2)return!1;return!0}function h(e,o,{viaRouteBase:n=!1,localSet:s,sommeLocaleRef:i,sommeGlobaleRef:a}){const d=[[e,0]],m=new Set([e]),h=[];for(;d.length;){const[e,p]=d.shift();if(p>=o)continue;const b=VERTEX_ADJ[e]||[];for(const o of b){if(m.has(o))continue;if(m.add(o),t.includes(o))continue;if(routeExiste(e,o)){const t=`${Math.min(e,o)}-${Math.max(e,o)}`;if(!u.has(t)&&(u.add(t),r)){routeCouleur?.(e,o)}continue}if(d.push([o,p+1]),!g(o))continue;const{total:b,logParts:E}=f(o),x=c.has(o),y=s.has(o),R=n;let v="limegreen",P=R?"✅ Nouveau sommet via route":"✅ Nouveau sommet";x||y?x&&!y?(s.add(o),i.value+=b,v="orange",P=`⚠️ Doublon global${R?" via route":""} (non compté globalement)`):y&&(v="#ff5f38ff",P=`⚠️ Doublon local${R?" via route":""} (ignoré)`):(c.add(o),s.add(o),l+=b,i.value+=b,a.value+=b),h.push({id:o,profondeur:p+1,qualite:b,viaRoute:R}),r&&E.forEach(e=>{})}}return h}if(r){}for(const t of e){const e=new Set,n={value:0},s={value:0},i=[],a=Array.from(routesExistantes).filter(e=>{const[n,r]=e.split("-").map(Number);return(n===t||r===t)&&routesCouleurs[e]===o});let c=null;if(a.length>0){const e=a[0],[o,n]=e.split("-").map(Number);c=o===t?n:o,u.add(`${Math.min(o,n)}-${Math.max(o,n)}`)}const{total:l,logParts:m}=f(t);r&&m.forEach(e=>{});if(h(t,3,{viaRouteBase:!1,localSet:e,sommeLocaleRef:n,sommeGlobaleRef:s}).forEach(e=>i.push(e)),null!=c){h(c,3,{viaRouteBase:!0,localSet:e,sommeLocaleRef:n,sommeGlobaleRef:s}).forEach(e=>i.push(e))}d.push({pion:t,nb:i.length,sommeLocale:n.value})}r&&d.forEach(e=>{});const p=Math.min(Math.max(l,0),130),b=document.getElementById("route").checked,E=b?2.9:2.6,x=b?1.25:1.9,y=p/130,R=Math.pow(y,E),v=Math.pow(1-y,x);return{scoreOuverture:l,ratioOuverture:.7+.5*(R/(R+v)),sommetsAccessibles:c.size,sommeQualite:l,detailsPions:d}}function afficherAnalyse({niveau:e,scores:t,ratio:o,ratioCap:n=1.1}){const r=document.getElementById("analyse-bar");if(!r)return;r.classList.add("hidden");const s=document.getElementById("colonie")?.checked??!1,i=document.getElementById("nombre")?.checked??!1,a=["Rouge","Bleu","Orange","Beige"].filter(e=>document.getElementById(e)?.checked).map(e=>e.toLowerCase());if(!s||!i||0===a.length)return;const c=document.documentElement.lang||document.querySelector("html").getAttribute("lang")||"fr",u=i18n[c]?.[`niv${e}`]??i18n.fr?.[`niv${e}`]??e,l=document.getElementById("niveau-badge"),d=document.getElementById("ratio-badge");if(!l||!d)return;const m=i18n[c]?.niveau??"Balancing",f=i18n[c]?.ratio??"Ratio";l.textContent=`${m} : ${u}`,d.textContent=`${f} : ${o.toFixed(2)} (≤ ${n.toFixed(2)})`,d.classList.remove("badge-ok","badge-warn","badge-danger"),d.classList.add(o<=n?"badge-ok":o<=n+.03?"badge-warn":"badge-danger");const g=document.getElementById("scores-strip"),h=e=>Number(e).toFixed(2),p=[];a.includes("rouge")&&p.push(`<span><span class="dot dot-rouge"></span>${h(t.rouge??0)}</span>`),a.includes("bleu")&&p.push(`<span><span class="dot dot-bleu"></span>${h(t.bleu??0)}</span>`),a.includes("orange")&&p.push(`<span><span class="dot dot-orange"></span>${h(t.orange??0)}</span>`),a.includes("beige")&&p.push(`<span><span class="dot dot-beige"></span>${h(t.beige??0)}</span>`),g.innerHTML=p.join(" | "),r.classList.remove("hidden")}function demarrerGeneration(e,t=0){e&&e.preventDefault(),e.stopPropagation(),e.target.blur();const o=document.getElementById("btn-generation");if(!o)return;const n=o.textContent,r=performance.now();o.classList.add("loading");const s=document.documentElement.lang||"fr";o.textContent=i18n[s]?.boutonLoading??"Génération...",setTimeout(()=>{generation(t);((performance.now()-r)/1e3).toFixed(2);o.classList.remove("loading"),o.textContent=n},100)}window.routesExistantes=routesExistantes,window.onload=()=>{const e=document.querySelectorAll(".hex-fond");e.forEach(e=>{e.classList.remove("visible"),e.style.transition="none",e.style.opacity="0"}),demarrerGeneration(),setTimeout(()=>{e.forEach(e=>{e.style.transition="opacity 0.4s ease",e.classList.add("visible")})},100)};